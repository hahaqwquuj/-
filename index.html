<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文档阅读器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== 基础样式 ===== */
        :root {
            --primary: #0969da;
            --primary-hover: #1a7f37;
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #f6f8fa;
            --border: #d0d7de;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --text-muted: #6e7781;
            --sidebar-width: 280px;
            --radius: 6px;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #58a6ff;
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-tertiary: #21262d;
                --border: #30363d;
                --text-primary: #c9d1d9;
                --text-secondary: #8b949e;
                --text-muted: #6e7681;
            }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); }
        
        /* ===== 布局 ===== */
        .app-container { display: flex; min-height: 100vh; }
        
        /* ===== 侧边栏 ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 0; left: 0; bottom: 0;
            z-index: 100;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
        }
        
        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-secondary);
        }
        
        .sidebar-content {
            padding: 16px 0;
            overflow-y: auto;
            height: calc(100vh - 120px);
        }
        
        /* ===== 文件树 ===== */
        .file-tree {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .file-tree ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .file-tree ul.expanded {
            max-height: 2000px;
        }
        
        .tree-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            text-decoration: none;
        }
        
        .tree-item:hover {
            background: var(--bg-tertiary);
        }
        
        .tree-item.active {
            background: rgba(9, 105, 218, 0.1);
            color: var(--primary);
            font-weight: 500;
            border-left: 3px solid var(--primary);
        }
        
        .tree-item.folder {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .tree-icon {
            width: 20px;
            margin-right: 8px;
        }
        
        /* ===== 主内容区 ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 40px 48px;
            max-width: 900px;
        }
        
        .content-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .content-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        /* ===== Markdown 样式 ===== */
        .markdown-body h1 { font-size: 28px; margin: 40px 0 20px; }
        .markdown-body h2 { font-size: 24px; margin: 32px 0 16px; }
        .markdown-body h3 { font-size: 20px; margin: 24px 0 12px; }
        .markdown-body p { margin-bottom: 16px; line-height: 1.6; }
        .markdown-body ul, .markdown-body ol { margin-bottom: 16px; padding-left: 24px; }
        .markdown-body code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; }
        .markdown-body pre { background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 16px 0; overflow-x: auto; }
        
        /* ===== 加载状态 ===== */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        /* ===== 移动端 ===== */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 24px; }
            .mobile-toggle { display: block !important; }
        }
        
        .mobile-toggle {
            display: none;
            position: fixed;
            top: 16px; left: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 99;
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i> 菜单
    </button>
    
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <i class="fas fa-book"></i>
                    <span>文档阅读器</span>
                </div>
            </div>
            
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="files">
                    <i class="fas fa-folder"></i>
                    文件
                </button>
            </div>
            
            <div class="sidebar-content">
                <ul class="file-tree" id="fileTree">
                    <!-- 动态生成 -->
                </ul>
            </div>
        </aside>
        
        <!-- 主内容 -->
        <main class="main-content" id="mainContent">
            <div class="content-header">
                <h1 class="content-title" id="pageTitle">文档阅读器</h1>
            </div>
            
            <div id="contentContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ===== 配置 =====
        const CONFIG = {
            // 修复：直接从当前页面获取正确的路径
            baseUrl: window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, ''),
            
            // 预定义的文件结构（根据您的仓库）
            knownFiles: [
                'README.md',
                '判断推理/一般归因.md',
                '判断推理/对比实验归因.md',
                '判断推理/时间对比归因.md',
                '言语理解/片段阅读.md',
                '言语理解/逻辑填空.md',
                '言语理解/词语理解.md',
                '言语理解/句子理解.md',
                '言语理解/篇章理解.md',
                '数量关系/速算技巧.md',
                '数量关系/公式大全.md',
                '数量关系/题型分类.md',
                '数量关系/解题技巧.md'
            ],
            
            // 使用简单模式（避免复杂的API调用）
            simpleMode: true
        };

        // ===== 状态管理 =====
        const state = {
            currentFile: 'README.md',
            collapsedFolders: new Set(),
            fileTree: null
        };

        // ===== 核心功能 =====
        
        // 1. 初始化应用
        async function initApp() {
            console.log('正在初始化应用...');
            
            // 绑定事件
            bindEvents();
            
            // 构建文件树
            buildFileTree();
            
            // 加载初始文档
            await loadDocument(state.currentFile);
            
            // 更新侧边栏
            updateSidebar();
        }

        // 2. 构建文件树
        function buildFileTree() {
            const tree = {
                name: 'root',
                type: 'folder',
                path: '',
                children: []
            };

            // 从预定义列表构建树
            CONFIG.knownFiles.forEach(filePath => {
                addFileToTree(tree, filePath);
            });

            state.fileTree = tree;
            renderFileTree();
        }

        // 3. 添加文件到树
        function addFileToTree(tree, filePath) {
            const parts = filePath.split('/');
            let current = tree;

            for (let i = 0; i < parts.length; i++) {
                const part = parts[i];
                const isFile = i === parts.length - 1;
                
                if (!current.children) current.children = [];

                if (isFile) {
                    // 添加文件
                    const existing = current.children.find(c => c.name === part);
                    if (!existing) {
                        current.children.push({
                            name: part,
                            type: 'file',
                            path: filePath,
                            displayName: part.replace('.md', '')
                        });
                    }
                } else {
                    // 添加或查找文件夹
                    let folder = current.children.find(c => c.name === part && c.type === 'folder');
                    if (!folder) {
                        folder = {
                            name: part,
                            type: 'folder',
                            path: parts.slice(0, i + 1).join('/'),
                            displayName: part,
                            children: []
                        };
                        current.children.push(folder);
                    }
                    current = folder;
                }
            }
        }

        // 4. 渲染文件树
        function renderFileTree() {
            const fileTree = document.getElementById('fileTree');
            
            if (!state.fileTree || !state.fileTree.children) {
                fileTree.innerHTML = '<div class="loading"><p>暂无文档</p></div>';
                return;
            }

            // 排序：文件夹在前，文件在后
            state.fileTree.children.sort((a, b) => {
                if (a.type === 'folder' && b.type === 'file') return -1;
                if (a.type === 'file' && b.type === 'folder') return 1;
                return a.displayName.localeCompare(b.displayName);
            });

            fileTree.innerHTML = generateTreeHTML(state.fileTree, 0);
            bindTreeEvents();
        }

        // 5. 生成树HTML
        function generateTreeHTML(node, level) {
            if (!node.children || node.children.length === 0) {
                return '';
            }

            let html = '';
            node.children.forEach(child => {
                const isFolder = child.type === 'folder';
                const isCollapsed = state.collapsedFolders.has(child.path);
                const isActive = state.currentFile === child.path;

                if (isFolder) {
                    html += `
                        <li class="tree-node">
                            <div class="tree-item folder ${isCollapsed ? 'collapsed' : ''}"
                                 data-path="${child.path}"
                                 data-level="${level}"
                                 data-type="folder">
                                <span class="tree-icon">
                                    <i class="fas ${isCollapsed ? 'fa-folder' : 'fa-folder-open'}"></i>
                                </span>
                                <span>${child.displayName}</span>
                            </div>
                            <ul class="${isCollapsed ? '' : 'expanded'}">
                                ${generateTreeHTML(child, level + 1)}
                            </ul>
                        </li>
                    `;
                } else {
                    // 只显示.md文件
                    if (child.name.endsWith('.md')) {
                        html += `
                            <li class="tree-node">
                                <a class="tree-item ${isActive ? 'active' : ''}"
                                   href="#${child.path}"
                                   data-path="${child.path}"
                                   data-level="${level}"
                                   data-type="file">
                                    <span class="tree-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </span>
                                    <span>${child.displayName}</span>
                                </a>
                            </li>
                        `;
                    }
                }
            });

            return html;
        }

        // 6. 加载文档
        async function loadDocument(filePath) {
            console.log('正在加载文档:', filePath);
            
            try {
                // 显示加载状态
                showLoading();
                
                // 更新状态
                state.currentFile = filePath;
                updateUrlHash(filePath);
                
                // 获取文件内容
                const content = await fetchFileContent(filePath);
                
                // 更新页面标题
                updatePageTitle(filePath);
                
                // 渲染内容
                renderContent(content);
                
                // 更新侧边栏激活状态
                updateActiveFile();
                
                // 确保文件夹展开
                ensureFolderExpanded(filePath);
                
            } catch (error) {
                console.error('加载失败:', error);
                showError(`无法加载文档: ${filePath}`);
            }
        }

        // 7. 获取文件内容（修复版本）
        async function fetchFileContent(filePath) {
            console.log('尝试获取文件:', filePath);
            
            // 修复：使用正确的路径
            let url;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // 本地开发
                url = filePath;
            } else {
                // GitHub Pages
                // 移除可能的重复路径
                const basePath = window.location.pathname.replace(/\/[^\/]*$/, '');
                url = basePath + '/' + filePath;
                
                // 清理URL中的双斜杠
                url = url.replace(/([^:])\/\//g, '$1/');
                
                // 如果是根目录的README.md
                if (filePath === 'README.md') {
                    // 尝试几种可能的路径
                    const possiblePaths = [
                        'README.md',
                        './README.md',
                        window.location.pathname.replace(/\/[^\/]*$/, '') + '/README.md'
                    ];
                    
                    for (const path of possiblePaths) {
                        try {
                            console.log('尝试路径:', path);
                            const response = await fetch(path);
                            if (response.ok) {
                                return await response.text();
                            }
                        } catch (e) {
                            continue;
                        }
                    }
                }
            }
            
            console.log('最终请求URL:', url);
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.text();
        }

        // 8. 更新页面标题
        function updatePageTitle(filePath) {
            const titleElement = document.getElementById('pageTitle');
            const fileName = filePath.split('/').pop().replace('.md', '');
            const folderName = filePath.includes('/') ? filePath.split('/')[0] : '';
            
            titleElement.textContent = fileName;
            document.title = `${fileName} - 文档阅读器`;
        }

        // 9. 渲染内容
        function renderContent(content) {
            const container = document.getElementById('contentContainer');
            
            // 简单的Markdown转HTML
            const html = markdownToHTML(content);
            
            container.innerHTML = `
                <div class="markdown-body">
                    ${html}
                </div>
            `;
            
            // 处理内部链接
            bindInternalLinks();
        }

        // 10. Markdown转HTML（简化版）
        function markdownToHTML(markdown) {
            if (!markdown) return '<p>文档内容为空</p>';
            
            let html = markdown;
            
            // 处理标题
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^#### (.*$)/gm, '<h4>$1</h4>');
            
            // 处理粗体和斜体
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 处理代码块
            html = html.replace(/```([\w]*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            
            // 处理内联代码
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // 处理无序列表
            html = html.replace(/^\s*[-*+] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            
            // 处理有序列表
            html = html.replace(/^\s*\d+\. (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // 处理段落
            const lines = html.split('\n');
            let result = [];
            let paragraph = [];
            
            for (let line of lines) {
                line = line.trim();
                
                if (!line) {
                    if (paragraph.length) {
                        result.push(`<p>${paragraph.join(' ')}</p>`);
                        paragraph = [];
                    }
                } else if (line.startsWith('<')) {
                    // 已经是HTML标签
                    if (paragraph.length) {
                        result.push(`<p>${paragraph.join(' ')}</p>`);
                        paragraph = [];
                    }
                    result.push(line);
                } else {
                    paragraph.push(line);
                }
            }
            
            if (paragraph.length) {
                result.push(`<p>${paragraph.join(' ')}</p>`);
            }
            
            return result.join('\n');
        }

        // 11. 初始化加载
        async function loadInitialDocument() {
            const hash = window.location.hash.substring(1);
            
            if (hash && hash.trim() !== '') {
                await loadDocument(hash);
            } else {
                await loadDocument('README.md');
            }
        }

        // 12. 绑定事件
        function bindEvents() {
            // 移动端菜单
            document.getElementById('mobileToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            // 监听hash变化
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                if (hash && hash !== state.currentFile) {
                    loadDocument(hash);
                }
            });
        }

        // 13. 绑定树事件
        function bindTreeEvents() {
            document.getElementById('fileTree').addEventListener('click', (e) => {
                const treeItem = e.target.closest('.tree-item');
                if (!treeItem) return;
                
                e.preventDefault();
                
                const type = treeItem.dataset.type;
                const path = treeItem.dataset.path;
                
                if (type === 'folder') {
                    toggleFolder(path);
                } else if (type === 'file') {
                    loadDocument(path);
                    
                    // 移动端自动关闭侧边栏
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('show');
                    }
                }
            });
        }

        // 14. 切换文件夹
        function toggleFolder(path) {
            if (state.collapsedFolders.has(path)) {
                state.collapsedFolders.delete(path);
            } else {
                state.collapsedFolders.add(path);
            }
            
            renderFileTree();
        }

        // 15. 更新URL hash
        function updateUrlHash(filePath) {
            window.location.hash = filePath;
        }

        // 16. 更新激活的文件
        function updateActiveFile() {
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (state.currentFile) {
                const activeItem = document.querySelector(`.tree-item[data-path="${state.currentFile}"]`);
                if (activeItem) {
                    activeItem.classList.add('active');
                }
            }
        }

        // 17. 确保文件夹展开
        function ensureFolderExpanded(filePath) {
            const parts = filePath.split('/');
            
            // 遍历所有父文件夹
            for (let i = 0; i < parts.length - 1; i++) {
                const folderPath = parts.slice(0, i + 1).join('/');
                state.collapsedFolders.delete(folderPath);
            }
            
            renderFileTree();
        }

        // 18. 更新侧边栏
        function updateSidebar() {
            // 根据当前文件更新侧边栏状态
            updateActiveFile();
        }

        // 19. 绑定内部链接
        function bindInternalLinks() {
            // 处理Markdown中的链接
            setTimeout(() => {
                document.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('.md')) {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            loadDocument(href);
                        });
                    }
                });
            }, 100);
        }

        // 20. 显示加载状态
        function showLoading() {
            const container = document.getElementById('contentContainer');
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载...</p>
                </div>
            `;
        }

        // 21. 显示错误
        function showError(message) {
            const container = document.getElementById('contentContainer');
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                    <p>请检查文件是否存在，或刷新页面重试。</p>
                </div>
            `;
        }

        // ===== 启动应用 =====
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('文档加载完成，启动应用...');
            console.log('当前URL:', window.location.href);
            console.log('当前路径:', window.location.pathname);
            
            try {
                await initApp();
                await loadInitialDocument();
                console.log('应用启动成功！');
            } catch (error) {
                console.error('应用启动失败:', error);
                showError('应用启动失败，请检查控制台。');
            }
        });
    </script>
</body>
</html>